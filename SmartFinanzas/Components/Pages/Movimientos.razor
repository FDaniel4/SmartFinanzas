@page "/movimientos"
@using SmartFinanzas.Modelos
@inject GestorMovimientos Gestor
@rendermode InteractiveServer

<h3>Movimientos</h3>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">

    @* --- TOAST DE ÉXITO --- *@
    @if (!string.IsNullOrEmpty(mensajeOk))
    {
        <div class="toast show align-items-center text-white bg-success border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body fs-6">
                    <i class="bi bi-check-circle-fill me-2"></i> @mensajeOk
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" @onclick="() => mensajeOk = null" aria-label="Close"></button>
            </div>
        </div>
    }

    @* --- TOAST DE ERROR --- *@
    @if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="toast show align-items-center text-white bg-danger border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body fs-6">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> @mensajeError
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" @onclick="() => mensajeError = null" aria-label="Close"></button>
            </div>
        </div>
    }

    @* --- TOAST DE SALDO (INFO) --- *@
    @if (!string.IsNullOrEmpty(mensajeSaldo))
    {
        <div class="toast show border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-primary text-white">
                <i class="bi bi-wallet2 me-2"></i>
                <strong class="me-auto">@mensajeSaldo</strong>
                <button type="button" class="btn-close btn-close-white" @onclick="() => mensajeSaldo = null" aria-label="Close"></button>
            </div>
            <div class="toast-body bg-light text-dark">
                <div class="d-flex justify-content-between"><span>Gastos:</span> <strong>@Gestor.TotalGastos()</strong></div>
                <div class="d-flex justify-content-between"><span>Ingresos:</span> <strong>@Gestor.TotalIngresos()</strong></div>
                <hr class="my-1">
                <div class="d-flex justify-content-between text-primary"><span>Total Saldo:</span> <strong>@Gestor.Saldo()</strong></div>
            </div>
        </div>
    }

</div>

<div class="card">
    <div class="card-header">
        <h4>@(editando ? "Modificar movimiento" : "Registrar movimiento")</h4>
    </div>
    <div class="card-body">
        <label class="form-label m-0">Concepto</label>
        <input type="text" class="form-control mb-2" @bind-value=nuevoMovimiento.Concepto />

        <label class="form-label m-0">Monto</label>
        <input type="number" class="form-control mb-2" @bind-value=nuevoMovimiento.Monto />

        <label class="form-label m-0">Tipo</label>
        <select class="form-select mb-2" @bind=nuevoMovimiento.Tipo>
            <option value="Ingreso">Ingreso</option>
            <option value="Gasto">Gasto</option>
        </select>

        <button class="btn btn-primary" @onclick="Agregar">
            @(editando ? "Guardar" : "Registrar")
        </button>
    </div>
</div>
<hr />
@if (movimientos.Count == 0)
{
    <p>Aun no hay movimientos registrados</p>
}
else
{
    <table class="table table-responsive table-striped">
        <thead>
            <tr>
                <th scope="col">Id</th>
                <th scope="col">Concepto</th>
                <th scope="col">Monto</th>
                <th scope="col">Tipo</th>
                <th scope="col">Acciones</th>

            </tr>
        </thead>
        <tbody>
            @foreach(var mov in movimientos)
            {   
                <tr>
                    <td scope="row">@mov.Id</td>
                    <td>@mov.Concepto</td>
                    <td>@mov.Monto</td>
                    <td>@mov.Tipo</td>
                    <td>
                        <div class="d-flex gap-2"><button class="btn btn-sm btn-danger" @onclick="() => ConfirmarEliminar(mov)"><i class="bi bi-trash"></i></button>
                            <button class="btn btn-sm btn-warning" @onclick="() => Editar(mov)"><i class="bi bi-pencil-square"></i></button>
                        </div>
                    </td>
                </tr>
            }
            </tbody>
    </table>
    <button class="btn btn-info" @onclick='async () => await MostrarSaldo("Balance Actual")'>
        Ver mi Saldo
    </button>

    @if (mostrarConfirmacion)
    {
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content shadow">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Confirmar eliminación</h5>
                    </div>

                    <div class="modal-body">
                        <p>
                            ¿Seguro que deseas eliminar el movimiento
                            <strong>@movimientoAEliminar?.Concepto</strong>?
                        </p>
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-secondary"
                                @onclick="CancelarEliminar">
                            Cancelar
                        </button>

                        <button class="btn btn-danger"
                                @onclick="EliminarConfirmado">
                            Sí, eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-backdrop fade show"></div>
    }

}

@code {
    private List<Movimiento> movimientos = new();
    private Movimiento nuevoMovimiento = new();
    private string? mensajeError = null;
    private string? mensajeOk = null;
    private string? mensajeSaldo = null;
    private bool editando = false;

    private Movimiento? movimientoAEliminar = null;
    private bool mostrarConfirmacion = false;

    protected override void OnInitialized()
    {
        // Cargar la lista al iniciar la página para ver lo que tiene el servicio
        movimientos = Gestor.ObtenerTodos();
    }
    private async Task Agregar()
    {
        if(string.IsNullOrWhiteSpace(nuevoMovimiento.Concepto))
        {
            await MostrarError("Escriba un concepto para la operación");
            return;
        }
        if (nuevoMovimiento.Monto <= 0)
        {
            await MostrarError("Ingrese un monto valido");
            return;
        }
        if (editando)
        {
            //Guardar edicion
            Gestor.Editar(nuevoMovimiento);
            await MostrarExito("Movimiento actualizado con exito");
            editando = false;
            nuevoMovimiento = new Movimiento();
        }
        else
        {
            var movimiento = new Movimiento
                {
                    Id = movimientos.Count + 1,
                    Concepto = nuevoMovimiento.Concepto,
                    Monto = nuevoMovimiento.Monto,
                    Tipo = nuevoMovimiento.Tipo
                };
            Gestor.Agregar(movimiento);
            movimientos = Gestor.ObtenerTodos();
            await MostrarExito("Movimiento agregado correctamente");
            nuevoMovimiento = new Movimiento();
        }
    }
    private void ConfirmarEliminar(Movimiento mov)
    {
        movimientoAEliminar = mov;
        mostrarConfirmacion = true;
    }

    private async Task EliminarConfirmado()
    {
        if (movimientoAEliminar is null)
            return;

        Gestor.Eliminar(movimientoAEliminar.Id);
        movimientos = Gestor.ObtenerTodos();

        mostrarConfirmacion = false;
        movimientoAEliminar = null;

        await MostrarExito("Movimiento eliminado correctamente");
    }
    private async Task Editar(Movimiento mov)
    {
        editando = true;
        nuevoMovimiento = new Movimiento
            {
                Id = mov.Id,
                Concepto = mov.Concepto,
                Monto = mov.Monto,
                Tipo = mov.Tipo
            };
    }

    private void CancelarEliminar()
    {
        mostrarConfirmacion = false;
        movimientoAEliminar = null;
    }

    private async Task MostrarExito(string mensaje)
    {
        mensajeOk = mensaje;
        StateHasChanged(); 
        
        await Task.Delay(3000);
        
        mensajeOk = null; 
        StateHasChanged();
    }

    private async Task MostrarError(string mensaje)
    {
        mensajeError = mensaje;
        StateHasChanged();
        
        await Task.Delay(3000); 
        
        mensajeError = null;
        StateHasChanged();
    }

    private async Task MostrarSaldo(string titulo)
    {
        mensajeSaldo = titulo;
        StateHasChanged();
        
        await Task.Delay(5000);
        
        mensajeSaldo = null;
        StateHasChanged();
    }
}